generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleType {
  PARTICIPANT
  MENTOR
  JURY
  TRAVEL_COORDINATOR
  HOSPITALITY_MANAGER
  ADMIN
}

enum AIMaturityStage {
  CONCEPT
  VALIDATED_IDEA
  PROTOTYPE
  SCALABLE_INNOVATION
}

model Role {
  id          String   @id @default(cuid())
  type        RoleType @unique
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
}

model User {
  id                  String   @id @default(cuid())
  fullName            String
  email               String   @unique
  phoneNumber         String   @db.VarChar(20)
  passwordHash        String
  roleId              String
  role                Role     @relation(fields: [roleId], references: [id])
  state               String
  institution         String
  domainOfInterest    String
  teamName            String?
  governmentId        String?
  isVerified          Boolean  @default(false)
  isApproved          Boolean  @default(false)
  registrationAt      DateTime @default(now())
  lastLoginAt         DateTime?
  failedLoginAttempts Int      @default(0)
  lockUntil           DateTime?
  deletedAt           DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  registrations       Registration[]
  teamMemberships     TeamMember[]
  ideas               Idea[]
  travelRecords       Travel[]
  accommodationItems  Accommodation[]
  mentorSessions      MentorSession[] @relation("MentorToSession")
  participantSessions MentorSession[] @relation("ParticipantToSession")
  vivaResponses       VivaResponse[]
  juryScores          JuryScore[]
  performanceIndexes  PerformanceIndex[]
  notifications       Notification[]
  activityLogs        ActivityLog[]
  otpCodes            OtpCode[]
  createdTeams        Team[]           @relation("CreatedTeams")

  @@index([roleId])
  @@index([state])
  @@index([domainOfInterest])
  @@index([isVerified, isApproved])
}

model Team {
  id          String   @id @default(cuid())
  name        String   @unique
  state       String
  domain      String
  createdById String
  createdBy   User     @relation("CreatedTeams", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  members              TeamMember[]
  ideas                Idea[]
  vivaQuestions        VivaQuestion[]
  juryScores           JuryScore[]
  performanceIndexes   PerformanceIndex[]

  @@index([state])
  @@index([domain])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String?
  joinedAt  DateTime @default(now())
  deletedAt DateTime?

  team      Team     @relation(fields: [teamId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([userId])
}

model Idea {
  id                   String          @id @default(cuid())
  title                String
  summary              String
  teamId               String
  ownerId              String
  ideaClarity          Float           @default(0)
  technicalFeasibility Float           @default(0)
  prototypeReadiness   Float           @default(0)
  marketValidation     Float           @default(0)
  improvementTrend     Float           @default(0)
  maturityStage        AIMaturityStage @default(CONCEPT)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  deletedAt            DateTime?

  team                 Team            @relation(fields: [teamId], references: [id])
  owner                User            @relation(fields: [ownerId], references: [id])

  @@index([teamId])
  @@index([ownerId])
  @@index([maturityStage])
}

model Registration {
  id           String   @id @default(cuid())
  userId        String
  status        String   @default("PENDING")
  remarks       String?
  processedById String?
  processedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  user          User     @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([processedById])
}

model Travel {
  id                     String   @id @default(cuid())
  userId                 String
  status                 String   @default("PENDING")
  expectedArrival        DateTime?
  actualArrival          DateTime?
  punctualityPercentage  Float    @default(0)
  logisticsIssuesCount   Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  deletedAt              DateTime?

  user                   User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Accommodation {
  id                     String   @id @default(cuid())
  userId                 String
  issue                  String?
  issueResolved          Boolean  @default(false)
  resolutionTimeMinutes  Int      @default(0)
  status                 String   @default("ASSIGNED")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  deletedAt              DateTime?

  user                   User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([issueResolved])
}

model MentorSession {
  id                     String   @id @default(cuid())
  mentorId               String
  participantId          String
  sessionDate            DateTime
  attended               Boolean  @default(false)
  punctualityPercentage  Float    @default(0)
  feedback               String?
  improvementScore       Float    @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  deletedAt              DateTime?

  mentor                 User     @relation("MentorToSession", fields: [mentorId], references: [id])
  participant            User     @relation("ParticipantToSession", fields: [participantId], references: [id])

  @@index([mentorId])
  @@index([participantId])
}

model VivaQuestion {
  id          String   @id @default(cuid())
  teamId       String
  question     String
  weightage    Float    @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  team         Team     @relation(fields: [teamId], references: [id])
  responses    VivaResponse[]

  @@index([teamId])
}

model VivaResponse {
  id             String   @id @default(cuid())
  questionId      String
  userId          String
  response        String
  score           Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  question        VivaQuestion @relation(fields: [questionId], references: [id])
  user            User         @relation(fields: [userId], references: [id])

  @@index([questionId])
  @@index([userId])
}

model JuryScore {
  id                        String   @id @default(cuid())
  juryId                     String
  teamId                     String
  preliminaryScore           Float    @default(0)
  fairnessScore              Float    @default(0)
  comments                   String?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  deletedAt                  DateTime?

  jury                       User     @relation(fields: [juryId], references: [id])
  team                       Team     @relation(fields: [teamId], references: [id])

  @@unique([juryId, teamId])
  @@index([teamId])
}

model PerformanceIndex {
  id                         String   @id @default(cuid())
  userId                      String?
  teamId                      String?
  ipi                         Float?
  tiss                        Float?
  eppi                        Float?
  contributionPercentage      Float    @default(0)
  milestoneCompletion         Float    @default(0)
  mentorImprovementScore      Float    @default(0)
  punctualityPercentage       Float    @default(0)
  vivaScore                   Float    @default(0)
  collaborationEfficiency     Float    @default(0)
  prototypeCompletionRate     Float    @default(0)
  juryPreliminaryScore        Float    @default(0)
  registrationEfficiency      Float    @default(0)
  travelPunctuality           Float    @default(0)
  accommodationResolution     Float    @default(0)
  sessionPunctuality          Float    @default(0)
  juryFairnessScore           Float    @default(0)
  calculatedAt                DateTime @default(now())
  deletedAt                   DateTime?

  user                        User?    @relation(fields: [userId], references: [id])
  team                        Team?    @relation(fields: [teamId], references: [id])

  @@index([userId])
  @@index([teamId])
  @@index([calculatedAt])
}

model Notification {
  id         String   @id @default(cuid())
  userId      String
  title       String
  message     String
  type        String   @default("INFO")
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId      String?
  action      String
  ipAddress   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  deletedAt   DateTime?

  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model OtpCode {
  id         String   @id @default(cuid())
  userId      String
  codeHash    String
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}
